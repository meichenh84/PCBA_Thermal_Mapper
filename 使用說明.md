# PCBA 溫度點位自動識別系統 — 使用說明

---

## 目錄

1. [系統概述](#1-系統概述)
2. [主介面總覽](#2-主介面總覽)
3. [第一步：載入資料夾與檔案](#3-第一步載入資料夾與檔案)
4. [第二步：對齊圖像](#4-第二步對齊圖像)
5. [第三步：溫度篩選與元器件辨識](#5-第三步溫度篩選與元器件辨識)
6. [第四步：編輯溫度（Edit Temperature）](#6-第四步編輯溫度edit-temperature)
7. [第五步：導出與寫入測試報告](#7-第五步導出與寫入測試報告)
8. [設定](#8-設定)
9. [鍵盤快捷鍵與滑鼠操作](#9-鍵盤快捷鍵與滑鼠操作)
10. [設定檔與輸出目錄](#10-設定檔與輸出目錄)
11. [常見問題](#11-常見問題)

---

## 1. 系統概述

本工具用於 PCBA（印刷電路板組件）熱力圖的溫度點位自動識別。透過將熱力圖與 PCB Layout 圖進行對齊，自動辨識出高溫元器件的位置與最高溫度，並支援手動編輯、導出 Excel 報告、寫入測試報告等功能。

**核心流程：**
```
載入資料夾 → 對齊圖像 → 溫度篩選辨識 → 編輯元器件 → 導出報告
```

---

## 2. 主介面總覽

啟動程式後，主介面分為三大區域：

### 頂部工具列

| 按鈕 | 顏色 | 功能 |
|------|------|------|
| 隱藏文件夾Tab | 綠色 | 顯示/隱藏左側檔案面板 |
| 對齊圖像開始 | 橘色 | 開始/結束圖像對齊模式 |
| 溫度過濾 | 藍色 | 開啟溫度篩選對話框 |
| 導出 | 深藍 | 導出 Excel 溫度報告 |
| 寫入測試報告 | 深藍 | 將結果寫入既有測試報告 |
| 設置 | 灰色 | 開啟顯示設定對話框 |

### 左側面板 — 檔案樹

顯示目前資料夾中所有被自動辨識的檔案，按六個類別分類（見下方說明）。

### 中央畫布區

- **左側畫布**：顯示熱力圖（Image A）
- **右側畫布**：顯示 PCB Layout 圖（Image B）

---

## 3. 第一步：載入資料夾與檔案

### 選擇資料夾

1. 點擊左側面板頂部的 **📂** 按鈕
2. 在檔案瀏覽器中選擇包含所有相關檔案的資料夾
3. 系統會**自動掃描並分類**資料夾中的檔案

### 檔案自動辨識規則

系統會依據以下規則自動將檔案分為六類：

| 類別 | 檔案類型 | 辨識條件 |
|------|----------|----------|
| **熱力圖** | .jpg / .png | HSV 色彩飽和度 > 80 且色相變異 > 1000 |
| **Layout 圖** | .jpg / .png | 黑色像素比例 > 60% |
| **溫度數據** | .csv | 第一行全為數值 |
| **元器件座標** | .xlsx | 包含 RefDes, Orient., X, Y 欄位 |
| **元器件尺寸** | .xlsx | 包含 RefDes, L, W, T, 對象描述 欄位 |
| **測試報告** | .xlsx | 包含含有 "HIGH" 的工作表名稱 |

### 檔案樹狀態圖示

- ✅ 已偵測且有效
- ❗ 缺少或驗證異常（例如有元器件座標但缺少元器件尺寸）

### 操作說明

- **點擊檔名**：切換為該檔案（粗體表示目前選取的檔案）
- **懸停檔名**：顯示完整檔名與偵測資訊的 Tooltip
- 每個類別標題顯示 `類別名稱 (數量)` 及狀態圖示

---

## 4. 第二步：對齊圖像

**目的**：建立熱力圖（A）與 Layout 圖（B）之間的座標轉換關係。

### 操作步驟

1. **開始對齊**：點擊頂部 **「對齊圖像開始」** 按鈕（按鈕變為「對齊圖像結束」）
2. **在熱力圖上標記對齊點**：在左側熱力圖上**左鍵點擊** 3～4 個特徵點
3. **在 Layout 圖上標記對應點**：在右側 Layout 圖上**左鍵點擊**對應的 3～4 個特徵點
4. **完成對齊**：再次點擊 **「對齊圖像結束」** 按鈕

### 注意事項

- 兩側必須標記**相同數量**的點（至少 3 個）
- 3 個點使用仿射變換（Affine），4 個以上使用透視變換（Homography）
- 系統會**自動匹配**兩側的點（以距離最小化配對，無需按順序標記）
- **右鍵點擊**：刪除附近 16 像素內的對齊點
- 對齊成功後會出現綠色提示 **「對齊成功」**

### 對齊結果查看

畫布下方提供兩個按鈕：
- **對齊前圖像**：查看熱力圖與 Layout 圖疊合（對齊前）
- **對齊後圖像**：查看對齊變換後的疊合效果

### 清除對齊點

- **清除熱力圖對齊點**：移除熱力圖上的所有標記點
- **清除 Layout 圖對齊點**：移除 Layout 圖上的所有標記點

---

## 5. 第三步：溫度篩選與元器件辨識

### 開啟篩選對話框

點擊頂部 **「溫度過濾」** 按鈕，開啟設定對話框。

### 設定參數

| 參數 | 說明 | 預設值 |
|------|------|--------|
| 最低溫度 | 篩選的最低溫度閾值（°C） | 50 |
| 最高溫度 | 篩選的最高溫度閾值（°C） | 80 |
| PCB 長度 | PCB 實際寬度（mm） | 237 |
| PCB 寬度 | PCB 實際高度（mm） | 194 |
| 座標原點 | 座標系統原點位置 | 左下 |
| 座標原點偏移 X | 原點 X 軸偏移量（mm） | 0 |
| 座標原點偏移 Y | 原點 Y 軸偏移量（mm） | 0 |
| 元器件內縮 | 上/下/左/右 邊界內縮（mm） | 0 |

### 確認並觸發辨識

1. 設定完參數後點擊 **「確認」**
2. 系統自動執行：
   - 讀取溫度 CSV 數據
   - 讀取元器件座標與尺寸資料
   - 透過座標轉換找到每個元器件在熱力圖上的對應位置
   - 查找每個元器件區域內的最高溫度
   - 僅保留溫度在設定範圍內的元器件
3. 辨識完成後，熱力圖與 Layout 圖上會顯示矩形標記框

### 開啟編輯器

**雙擊熱力圖**即可開啟 Edit Temperature 編輯器進行詳細編輯。

---

## 6. 第四步：編輯溫度（Edit Temperature）

雙擊熱力圖開啟編輯器後，介面分為三個區域：

### 6.1 左側面板 — 元器件列表

#### 篩選功能

列表上方提供三組篩選輸入框：

| 篩選欄位 | 位置 | 說明 |
|----------|------|------|
| **點位名稱** | 第一列 | 輸入 `C,HS` 篩選包含 C 或 HS 的項目 |
| **描述** | 第二列 | 按描述關鍵字篩選（如 `EC,CAP`） |
| **溫度** | 第二列 | 按溫度範圍篩選 |

**名稱篩選格式**：
- 單一值：`C` → 篩選包含 C 的項目
- 多值 OR：`C,HS` 或 `"C","HS"` → 篩選包含 C 或 HS 的項目

#### 「刪除其他」按鈕

- 先用篩選條件篩選出要保留的元器件
- 點擊後，不符合篩選條件的項目將被刪除
- 可透過「回到上一步」復原，或用「加回元器件」找回
- 也可透過「回到起點」恢復為最初辨識結果

#### 表格欄位

| 欄位 | 說明 | 排序 |
|------|------|------|
| 點位名稱 | 元器件名稱（RefDes） | 點擊表頭，A→Z 排序 |
| 描述 | 元器件描述 | 點擊表頭，A→Z 排序 |
| 溫度 | 區域最高溫度（°C） | 點擊表頭，高→低排序 |

- 欄位寬度可拖曳調整
- 懸停列表項目顯示完整資訊 Tooltip

#### 選取操作

- **單擊**：選取單一元器件（同時在畫布上高亮）
- **Ctrl + 點擊**：逐一加選/取消
- **Shift + 點擊**：範圍選取

---

### 6.2 中央畫布 — 熱力圖編輯

#### 基本操作

- **單擊矩形框**：選取該元器件
- **拖曳矩形框內部**：移動元器件位置
- **拖曳邊角錨點**：調整矩形框大小
- **雙擊空白區域**：取消選取
- **在空白區域拖曳**：建立新的矩形標記
- 選取的矩形框顯示為藍色，附帶 8 個邊角錨點

#### 放大模式

- 勾選工具列的 **「放大模式」** 開關
- **滾輪上/下**：放大/縮小熱力圖
- **右鍵拖動**：平移檢視區域
- 滾輪縮小到最小即回到預設大小
- 取消勾選自動恢復預設顯示

---

### 6.3 右側工具列

工具列由上到下包含以下功能：

#### Row 0：保存並關閉

- 保存目前所有編輯結果
- 關閉編輯器並返回主介面
- 主介面的熱力圖會即時更新

#### Row 1：回到起點

- **無視任何編輯與保存結果**，直接恢復為溫度篩選後的原始辨識狀態
- 即使關閉編輯器後重新開啟，仍可恢復至最初辨識的完整元器件列表
- 此操作會清除所有修改紀錄
- 按鈕綠色 = 可使用；灰色 = 目前已是初始狀態

#### Row 2：回到上一步

- 復原最近一次操作（最多保留 3 步）
- 快捷鍵：**Ctrl+Z**
- 按鈕顯示 `回到上一步 (n/3)` 表示剩餘可復原次數

#### Row 3：已選取提示

- 顯示目前已選取的元器件數量（例如「已選取 3 個」）

#### Row 4：合併

- 將多選的元器件合併為一個
- 需先選取 2 個以上元器件才會啟用

#### Row 5：刪除

- 刪除選取的元器件
- 快捷鍵：**Delete / BackSpace**

#### Row 6～8：形狀轉換

- **轉為矩形 ⬜**：將圓形標記轉為矩形
- **轉為圓形 ⚪**：將矩形標記轉為圓形
- 轉換後會重新查找框選範圍內的最高溫度
- 圓形只計算圓形內部的溫度點（排除四角）
- 支援多選批次轉換

#### Row 9～10：溫度位置（九宮格）

- 設定溫度數值文字相對於三角形標記的顯示方向
- 點擊 8 個方位按鈕（↖ ↑ ↗ ← → ↙ ↓ ↘）調整
- 中心為三角形位置（不可點擊）
- 支援多選批次設定

#### Row 11～13：旋轉角度

- 矩形框以幾何中心為軸逆時針旋轉
- **預設角度**：0° / 45° / 90° / 135°（一鍵點選）
- **自訂角度**：輸入任意角度後點擊「套用」
- 旋轉後最高溫度會在新區域內重新查找
- 圓形不支援旋轉
- 支援多選批次旋轉

#### Row 14：放大模式（勾選框）

- 勾選後可用滾輪放大/縮小熱力圖
- 右鍵拖動可平移檢視區域
- 滾輪縮小到最小即回到預設大小
- 取消勾選自動恢復預設顯示

#### Row 15：溫度座標（勾選框）

- 勾選後，將滑鼠移動到熱力圖上即可顯示該位置的溫度與座標
- 格式：`溫度(X, Y)`
- 座標根據溫度篩選設定的起始座標方向計算（例如設定「左下」則左下角為 (0, 0)）
- 標籤會自動跟隨游標移動，靠近邊界時自動翻轉方向

#### Row 16：多選模式（勾選框）

- 勾選後可在列表中選取多個元器件
- 支援 Ctrl+點擊 逐一加選
- 支援 Shift+點擊 範圍選取
- 選取多個後可批次轉換形狀、旋轉或刪除

#### Row 17～18：加回元器件

- 勾選後，移動游標至熱力圖上
- 任何不在左側列表中的元器件都可透過此功能加回
- 游標移至對應位置時，右側資訊框顯示該元器件名稱、描述與座標
- **雙擊**即可加回熱力圖和列表

---

## 7. 第五步：導出與寫入測試報告

### 導出 Excel 報告

1. 完成溫度篩選或編輯後，點擊頂部 **「導出」** 按鈕
2. 系統自動建立 `output/` 子目錄並輸出：
   - **report.xlsx**：Excel 報告，包含「點位名稱 / 描述 / 溫度」三欄
   - **A.jpg**：標記了所有元器件框線的熱力圖影像
3. 若檔案已存在，自動命名為 `report1.xlsx`、`report2.xlsx` ...
4. 導出成功後顯示綠色提示

### 寫入測試報告

1. 確保資料夾中有被偵測為「測試報告」的 .xlsx 檔案（含 "HIGH" 工作表）
2. 點擊 **「寫入測試報告」** 按鈕（未偵測到測試報告時此按鈕為停用狀態）
3. 選擇 Sheet 名稱：
   - **High_Vac_Data**（預設選項）
   - **Low_Vac_Data**
   - **自訂名稱**（手動輸入）
4. 系統會在該測試報告中建立新工作表，寫入：
   - 粗體表頭：點位名稱 | 描述 | 溫度 (°C)
   - 所有元器件資料
   - 嵌入標記後的熱力圖
5. 若工作表名稱重複，自動加上編號（如 `High_Vac_Data_1`）

---

## 8. 設定

點擊頂部 **「設置」** 按鈕開啟設定對話框。

### 熱力圖標記設定

| 設定項 | 說明 | 預設值 |
|--------|------|--------|
| 矩形框顏色 | 元器件標記框的顏色 | #BCBCBC（灰） |
| 元器件名稱顏色 | 名稱文字顏色 | #FFFFFF（白） |
| 元器件名稱字體大小 | 名稱文字大小 | 28 |
| 最高溫度顏色 | 溫度文字顏色 | #FF0000（紅） |
| 最高溫度字體大小 | 溫度文字大小 | 14 |
| 選中矩形框顏色 | 選取狀態的框色 | #4A90E2（藍） |
| 選中矩形框錨點顏色 | 邊角錨點顏色 | #FF0000（紅） |
| 選中矩形框錨點半徑 | 錨點大小 | 4 |
| 矩形框線粗細 | 框線寬度（1～5） | 1 |

### Layout 圖標記設定

與熱力圖相同的設定項目（獨立設定）。

### 操作說明

- 每個顏色設定提供色票預覽 + RGB 輸入框 + 「選擇顏色」按鈕
- 點擊 **「確認」** 保存並即時生效
- 點擊 **「取消」** 放棄變更

---

## 9. 鍵盤快捷鍵與滑鼠操作

### 主介面

| 操作 | 功能 |
|------|------|
| 左鍵點擊（對齊模式） | 新增對齊點 |
| 右鍵點擊（對齊模式） | 移除附近的對齊點 |
| 雙擊熱力圖 | 開啟 Edit Temperature 編輯器 |

### Edit Temperature 編輯器

| 操作 | 功能 |
|------|------|
| 左鍵點擊矩形框 | 選取元器件 |
| Ctrl + 左鍵 | 加選/取消選取 |
| Shift + 左鍵（列表中） | 範圍選取 |
| 拖曳矩形框內部 | 移動位置 |
| 拖曳邊角錨點 | 調整大小 |
| 空白處拖曳 | 建立新矩形 |
| 雙擊空白處 | 取消選取 |
| Delete / BackSpace | 刪除選取的元器件 |
| Ctrl + Z | 回到上一步 |
| 滾輪上/下（放大模式） | 放大/縮小 |
| 右鍵拖動（放大模式） | 平移檢視區域 |

---

## 10. 設定檔與輸出目錄

### 目錄結構

```
{工作資料夾}/
├── config/
│   ├── config.json               ← 全域顯示設定（顏色、字體等）
│   └── temperature_config.json   ← 溫度篩選參數 + 檔案選擇記錄
├── points/
│   └── {熱力圖}_{Layout圖}_imageA.csv  ← 對齊點座標
├── output/
│   ├── report.xlsx               ← 導出的 Excel 報告
│   └── A.jpg                     ← 標記後的熱力圖
└── logs/                         ← 日誌目錄
```

### temperature_config.json 範例

```json
{
  "min_temp": 50.0,
  "max_temp": 80.0,
  "p_w": 237.0,
  "p_h": 194.0,
  "p_origin": "左下",
  "current_heat_file": "熱力圖.jpg",
  "current_layout_file": "Layout圖.png",
  "current_temp_file": "溫度數據.csv",
  "current_layout_xy_file": "元器件座標.xlsx",
  "current_layout_lwt_file": "元器件尺寸.xlsx"
}
```

所有設定在切換資料夾時自動保存，再次開啟同一資料夾時自動還原。

---

## 11. 常見問題

| 問題 | 解決方式 |
|------|----------|
| 對齊失敗：「點位異常」 | 確保兩側各標記 3 個以上的點，且點不共線 |
| 溫度篩選後顯示 0 個元器件 | 調整溫度範圍、確認對齊是否正確 |
| 導出按鈕無反應 | 需先執行溫度篩選，確保有元器件被辨識 |
| 寫入測試報告按鈕灰色 | 資料夾中需有含 "HIGH" 工作表的 .xlsx 檔案 |
| 檔案類別顯示 ❗ | 元器件座標與元器件尺寸需同時存在 |
| 回到起點按鈕灰色 | 目前狀態已與原始辨識結果相同，無需恢復 |
| 熱力圖/Layout 圖未偵測到 | 確認圖片格式為 .jpg 或 .png，且符合自動辨識條件 |
